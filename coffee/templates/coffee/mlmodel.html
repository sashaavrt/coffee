{% extends 'coffee/base.html' %}
{% block content %}

<h1 class="text-3xl font-bold mb-6">{{ mlmodel.name }}</h1>
<p class="text-sm text-gray-800">
      üß™ <span class="font-semibold">–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏:</span>
      <span class="font-bold text-green-700">{{ mlmodel.quality }}%</span>
    </p>
    <p class="text-sm text-yellow-800 mt-1">
      ‚ö†Ô∏è –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –ø—Ä–æ–≥–Ω–æ–∑ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω—ã–º –∏ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏.
    </p>

{% if mlmodel.id == 1 %}
  <form method="POST" class="card">
    {% csrf_token %}
    <div class="mb-4">
      <label for="start_date" class="font-semibold">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="start_date" name="start_date" class="border p-2 rounded mr-2">

      <label for="end_date" class="font-semibold">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="end_date" name="end_date" class="border p-2 rounded">
    </div>

    <div class="mb-4">
      <label class="font-semibold block mb-2">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–æ—á–∫–∞–º –ø—Ä–æ–¥–∞–∂:</label>
      {% for loc in all_locations %}
        <label class="inline-flex items-center mr-4">
          <input type="checkbox" name="locations" value="{{ loc }}" class="mr-1">
          {{ loc }}
        </label>
      {% endfor %}
    </div>

    <button type="submit" class="btn-primary">
      –ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å
    </button>
  </form>
  <form method="post" action="{% url 'save_to_archive' %}">
    {% csrf_token %}
    <input type="hidden" name="graph_base64" value="{{ graph|safe }}">
    <input type="hidden" name="table_base64" value="{{ table|safe }}">
    <input type="hidden" name="mlmodel_id" value="{{ mlmodel.id }}">
    <input type="hidden" name="metric_name" value="{{ mlmodel.name }}">
    <input type="hidden" name="metric_description" value="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –º–æ–¥–µ–ª–∏ {{ mlmodel.name }}">
    <button type="submit" class="btn btn-dark">–ê—Ä—Ö–∏–≤</button>
</form>
 <br>

  {% if forecast_summary %}
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
      <p class="text-2xl text-blue-800 font-bold mb-4">{{ forecast_summary }}</p>
      <canvas id="forecastChart" class="w-full max-w-3xl"></canvas>
    </div>
    <br>
    <br>
  {% endif %}
{% elif mlmodel.id == 2 %}
  <form method="POST" class="card mb-6">
    {% csrf_token %}
    <div class="mb-4">
      <label for="start_date" class="font-semibold">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="start_date" name="start_date" class="border p-2 rounded mr-2" required>

      <label for="end_date" class="font-semibold">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="end_date" name="end_date" class="border p-2 rounded">
    </div>

    <button type="submit" class="btn-primary">–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å</button>
  </form>
   {% if forecast_list %}
  <form method="post" action="{% url 'save_to_archive' %}">
    {% csrf_token %}
    <input type="hidden" name="table_base64" value="{{ table|safe }}">
    <input type="hidden" name="graph_base64" value="">
    <input type="hidden" name="mlmodel_id" value="{{ mlmodel.id }}">
    <input type="hidden" name="metric_name" value="{{ mlmodel.name }}">
    <input type="hidden" name="metric_description" value="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –º–æ–¥–µ–ª–∏ {{ mlmodel.name }}">
    <button type="submit" class="btn btn-dark">–ê—Ä—Ö–∏–≤</button>
  </form>
{% endif %}

 <br>
  {% if forecast_list %}
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">–¢–æ–ø-3 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π:</h2>
      <ul class="list-disc ml-6 text-lg">
        {% for line in forecast_list %}
          <li>{{ line }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% elif mlmodel.id == 3 %}
  <form method="POST" class="card mb-6">
    {% csrf_token %}
    <div class="mb-4">
      <label for="start_date" class="font-semibold">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="start_date" name="start_date" class="border p-2 rounded mr-2" required>

      <label for="end_date" class="font-semibold">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="end_date" name="end_date" class="border p-2 rounded">
    </div>

    <button type="submit" class="btn-primary">–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å</button>
  </form>
 <form method="post" action="{% url 'save_to_archive' %}">
    {% csrf_token %}
    <input type="hidden" name="graph_base64" value="{{ graph|safe }}">
    <input type="hidden" name="table_base64" value="{{ table|safe }}">
    <input type="hidden" name="mlmodel_id" value="{{ mlmodel.id }}">
    <input type="hidden" name="metric_name" value="{{ mlmodel.name }}">
    <input type="hidden" name="metric_description" value="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –º–æ–¥–µ–ª–∏ {{ mlmodel.name }}">
    <button type="submit" class="btn btn-dark">–ê—Ä—Ö–∏–≤</button>
</form>
 <br>
  {% if forecast_summary %}
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
      <p class="text-xl text-orange-800 font-bold mb-4">{{ forecast_summary }}</p>
      <canvas id="forecastChart" class="w-full max-w-3xl"></canvas>
    </div>
  {% endif %}
{% elif mlmodel.id == 4 %}
  <form method="POST" class="card mb-6">
    {% csrf_token %}
    <div class="mb-4">
      <label for="start_date" class="font-semibold">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="start_date" name="start_date" class="border p-2 rounded mr-2" required>

      <label for="end_date" class="font-semibold">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
      <input type="date" id="end_date" name="end_date" class="border p-2 rounded">
    </div>

    <button type="submit" class="btn-primary">–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å</button>
  </form>
 {% if forecast_list %}
  <form method="post" action="{% url 'save_to_archive' %}">
    {% csrf_token %}
    <input type="hidden" name="table_base64" value="{{ table|safe }}">
    <input type="hidden" name="graph_base64" value="">
    <input type="hidden" name="mlmodel_id" value="{{ mlmodel.id }}">
    <input type="hidden" name="metric_name" value="{{ mlmodel.name }}">
    <input type="hidden" name="metric_description" value="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ –º–æ–¥–µ–ª–∏ {{ mlmodel.name }}">
    <button type="submit" class="btn btn-dark">–ê—Ä—Ö–∏–≤</button>
  </form>
{% endif %}

 <br>
  {% if forecast_list %}
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏:</h2>
      <ul class="list-disc ml-6 text-lg">
        {% for line in forecast_list %}
          <li>{{ line }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endif %}

<br>
<br>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const canvas = document.getElementById("forecastChart") || document.getElementById("trendChart");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");

  const labels = {{ chart_labels|safe }};
  const chartData = {{ chart_values|safe }};


  let yLabel = "";
  let chartType = "line";
  {% if mlmodel.id == 1 %}
    yLabel = "–ü—Ä–æ–¥–∞–∂–∏";
    chartType = "bar";
  {% elif mlmodel.id == 2 %}
    yLabel = "–¢—Ä–µ–Ω–¥—ã";
  {% elif mlmodel.id == 3 %}
    yLabel = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞";
  {% elif mlmodel.id == 4 %}
    yLabel = "–ü–æ—Å—Ç–∞–≤–∫–∏";
  {% endif %}

  const baseDataset = {
    label: yLabel,
    data: chartData,
    backgroundColor: chartType === 'bar' ? 'rgba(54, 162, 235, 0.6)' : 'rgba(54, 162, 235, 0.3)',
    borderColor: 'rgba(54, 162, 235, 1)',
    borderWidth: 2,
    fill: chartType !== 'bar',
    tension: 0.4,
    pointRadius: chartType === 'bar' ? 0 : 3,
    type: chartType
  };

  const thresholdLines = [
    {
      label: '–ù–∏–∑–∫–∞—è',
      data: Array(labels.length).fill(10),
      borderColor: 'green',
      borderDash: [6, 3],
      borderWidth: 2,
      fill: false,
      pointRadius: 0,
      type: 'line'
    },
    {
      label: '–°—Ä–µ–¥–Ω—è—è',
      data: Array(labels.length).fill(20),
      borderColor: 'orange',
      borderDash: [6, 3],
      borderWidth: 2,
      fill: false,
      pointRadius: 0,
      type: 'line'
    },
    {
      label: '–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π',
      data: Array(labels.length).fill(30),
      borderColor: 'orangered',
      borderDash: [6, 3],
      borderWidth: 2,
      fill: false,
      pointRadius: 0,
      type: 'line'
    },
    {
      label: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è',
      data: Array(labels.length).fill(35),
      borderColor: 'red',
      borderDash: [6, 3],
      borderWidth: 2,
      fill: false,
      pointRadius: 0,
      type: 'line'
    }
  ];

const config = {
  type: chartType,
  data: {
    labels: labels,
    datasets: [baseDataset, ...thresholdLines]
  },
  options: {
    responsive: true,
    animation: {
      onComplete: function () {
        const graphInput = document.querySelector('input[name="graph_base64"]');
        if (graphInput && canvas) {
          try {
            const imageData = canvas.toDataURL("image/png");
            graphInput.value = imageData;
            console.log("üìà –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ input.");
          } catch (err) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:", err);
          }
        }
      }
    },
    plugins: {
      legend: {
        position: 'top',
      }
    },
    interaction: {
      mode: 'index',
      intersect: false
    },
    scales: {
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: yLabel
        }
      }
    }
  }
};


  new Chart(ctx, config);
const graphInput = document.querySelector('input[name="graph_base64"]');
  if (graphInput && canvas) {
    try {
      const imageData = canvas.toDataURL("image/png");
      graphInput.value = imageData;
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ canvas:", err);
    }
  }
});
</script>

{% endblock %}
